// ==UserScript==
// @name         Doc: Nations
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.4
// @description  Improves the Nations page UI
// @author       BlackAsLight
// @match        https://politicsandwar.com/nations/
// @include      https://politicsandwar.com/index.php?id=15*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
function r(e,i,...t){return typeof e!="string"?e(i,...t):{type:e,props:i,children:t.flat()}}function l(e){let i=document.createElement(e.type);if(f(i,e.props),e.children){let t=i,n=[0],o;do{{let a=e;for(let p=n.length-1;0<p;--p)a=a.children[n[p]];o=a.children}for(;n[0]<o.length;)if(typeof o[n[0]]!="object")t.append(o[n[0]++]);else{let a=document.createElement(o[n[0]].type);a.toString()==="[object HTMLUnknownElement]"?t.append(o[n[0]++]):(t.append(a),f(a,o[n[0]].props),t=a,o=o[n[0]].children??[],n.unshift(0))}t=t.parentElement,n.shift(),++n[0]}while(n.length&&t)}return i}function f(e,i){if(i){let t=Object.entries(i);for(let n=0;n<t.length;++n)e.setAttribute(t[n][0],t[n][1])}}function c(e,i){return i(e),e}if(document.querySelector("#Doc_Nations"))throw Error("This script was already injected...");document.body.append(l(r("div",{id:"Doc_Nations",style:"display: none;"})));var s="Doc_N1",m="Doc_N2",d=document.querySelector('form[method="GET"]');d.parentElement?.insertBefore(l(r("div",null,r("label",{for:"Doc_Score"},"Nation Score: "),c(l(r("input",{id:"Doc_Score",type:"number",value:`${localStorage.getItem(s)??0}`})),e=>e.addEventListener("change",i=>{let t=i.target,n=parseFloat(t.value);if(`${n}`=="NaN")return;let o=new Date;t.nextSibling&&(t.nextSibling.textContent=o.toJSON()),localStorage.setItem(m,`${o.getTime()}`),localStorage.setItem(s,`${n}`),g(n)})),r("br",null),new Date(parseInt(localStorage.getItem(m)??"0")).toJSON(),c(l(r("button",{class:"btn btn-primary",style:"margin-inline: 0.5em;"},"Refresh")),e=>e.addEventListener("click",async i=>{let t=i.target;t.toggleAttribute("disabled",!0);let n=parseFloat(new DOMParser().parseFromString(await(await fetch("https://politicsandwar.com/nation/war/")).text(),"text/html").querySelector("a.btn.btn-warning.btn-lg").href.split("?")[1].split("&").find(a=>a.startsWith("keyword="))?.slice(8)??"0");console.log(`Score: ${n}`);let o=new Date;t.previousSibling&&(t.previousSibling.textContent=o.toJSON()),localStorage.setItem(m,`${o.getTime()}`),localStorage.setItem(s,`${n}`),g(n),t.previousElementSibling.previousElementSibling.value=`${n}`,t.toggleAttribute("disabled",!1)})))),d.nextElementSibling);g(parseFloat(localStorage.getItem(s)??"0"));function T(e,i){return i*.4<=e&&e<=i*2.5}function u(e,i){return i*.75<=e&&e<=i*1.75}function g(e){[...document.querySelectorAll(".nationtable tr")].slice(1).forEach(i=>{let t=i.lastElementChild,n=parseFloat(t.lastChild?.textContent?.replaceAll(",",""));[...t.querySelectorAll("img")].forEach(o=>{o.src!=="https://politicsandwar.com/img/icons/16/plus_shield.png"&&o.remove()}),T(n,e)&&t.insertBefore(l(r("img",{src:"https://politicsandwar.com/img/icons/16/emotion_spy.png"})),t.lastChild),u(n,e)?u(e,n)?t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/green_red.png"})),t.lastChild):t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/green.png"})),t.lastChild):u(e,n)&&t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/red.png"})),t.lastChild)})}
