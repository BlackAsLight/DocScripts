// ==UserScript==
// @name         Doc: Military
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.4
// @description  Making it easier to militarise and demilitarise your army.
// @author       BlackAsLight
// @match        https://politicsandwar.com/nation/military/
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
function r(t,o){let e=document.createElement(t);return o&&o(e),e}var m={APIKey(t){return localStorage[t===void 0?"getItem":t!==null?"setItem":"removeItem"]("Doc_APIKey",t)},Hash(t){return localStorage[t===void 0?"getItem":t!==null?"setItem":"removeItem"]("!Doc_Hash",t)},async Token(t){let o=await t(localStorage.getItem("!Doc_Token"));localStorage[o!==null?"setItem":"removeItem"]("!Doc_Token",o)},aSynclyLastChecked(t){if(t===void 0)return parseInt(localStorage.getItem("!Doc_aS1")??"0")||0;if(t!==null)return localStorage.setItem("!Doc_aS1",t.toString());localStorage.removeItem("!Doc_aS1")}};function b(t){return new Promise(o=>setTimeout(()=>o(!0),t))}function i(){return r("div",t=>t.classList.add("spacer"))}function y(){return document.querySelector("#Doc_Config")??r("div",t=>{document.querySelector("#leftcolumn").append(t),t.setAttribute("id","Doc_Config")})}function L(t){let o=y();o.append(document.createElement("hr")),o.append(r("b",e=>e.append(t)))}function E(){let t=y();t.append(document.createElement("br")),t.append(r("button",o=>{let e=m.APIKey();o.append(e?"Update API Key":"Insert API Key"),o.addEventListener("click",n=>{let a=prompt("Insert API Key | It can be found at the bottom of the Accounts Page:",e??"");a!==null&&(m.APIKey(a||null),location.reload())})}))}if(document.querySelector("#Doc_Military"))throw Error("This script was already injected...");document.body.append(r("div",t=>{t.setAttribute("id","Doc_Military"),t.style.setProperty("display","none")}));fetch("https://politicsandwar.com/nation/military/soldiers/").then(t=>t.text()).then(t=>sessionStorage.setItem("Doc_Token",new DOMParser().parseFromString(t,"text/html").querySelector('input[name="token"]').value));var s=fetch(`https://api.politicsandwar.com/graphql?api_key=${m.APIKey()}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"{me{nation{soldiers,soldiers_today,tanks,tanks_today,aircraft,aircraft_today,ships,ships_today,cities{barracks,factory,hangar,drydock},propaganda_bureau}}}"})}).then(t=>t.json()).then(t=>t.data.me.nation),h=!1;L("Military");E();document.head.append(r("style",t=>{t.textContent+=".doc_military { display: grid; grid-template-columns: repeat(2, calc(50% - 0.5rem)); gap: 1rem; }",t.textContent+=".doc_military a { grid-column: 1 / 3; text-align: center; }",t.textContent+=".spacer-row { display: flex; flex-direction: row; align-items: center; }",t.textContent+=".spacer { flex-grow: 1; }",t.append("#Doc_Config { text-align: center; padding: 0 1em; font-size: 0.8em; }"),t.append("#Doc_Config b { font-size: 1.25em; }"),t.append("#Doc_Config button { font-size: inherit; font-weight: normal; padding: 0; }"),t.append("#Doc_Config hr { margin: 0.5em 0; }")}));r("form",t=>{let o=document.querySelector("#rightcolumn>.row");o.parentElement.insertBefore(t,o),o.remove(),t.classList.add("doc_military"),t.append(r("label",e=>{e.classList.add("spacer-row"),e.append("Soldiers Enlisted:",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.soldiers.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Soldiers Enlisted Today:",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.soldiers_today.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Enlist/Discharge:",i(),r("input",n=>{n.setAttribute("type","number"),n.setAttribute("name","soldiers"),n.setAttribute("value","0"),s.then(a=>{let l=a.cities.reduce((d,c)=>d+c.barracks,0)*3e3;n.value=Math.min(Math.round(l/3*(a.propaganda_bureau?1.1:1)-a.soldiers_today),l-a.soldiers).toString()})}))}),r("input",e=>{e.setAttribute("type","submit"),e.setAttribute("name","buysoldiers"),e.setAttribute("value","Enlist/Discharge Soldiers")}),r("input",e=>{e.setAttribute("type","hidden"),e.setAttribute("name","token"),u().then(n=>e.setAttribute("value",n))}),r("a",e=>{e.setAttribute("href","https://politicsandwar.com/nation/military/soldiers/"),e.textContent="Go to Page"})),t.addEventListener("submit",p,{passive:!1}),[...t.querySelectorAll("input")].forEach(e=>e.toggleAttribute("disabled",!0)),s.then(e=>u().then(n=>[...t.querySelectorAll("input")].forEach(a=>a.toggleAttribute("disabled",!1))))});r("form",t=>{let o=document.querySelector("#rightcolumn>.row");o.parentElement.insertBefore(t,o),o.remove(),t.classList.add("doc_military"),t.append(r("label",e=>{e.classList.add("spacer-row"),e.append("Tanks Possessed: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.tanks.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Tanks Manufactured Today: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.tanks_today.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Manufacture/Decommission: ",i(),r("input",n=>{n.setAttribute("type","number"),n.setAttribute("name","tanks"),n.setAttribute("value","0"),s.then(a=>{let l=a.cities.reduce((d,c)=>d+c.factory,0)*250;n.value=Math.min(Math.round(l/5*(a.propaganda_bureau?1.1:1)-a.tanks_today),l-a.tanks).toString()})}))}),r("input",e=>{e.setAttribute("type","submit"),e.setAttribute("name","buytanks"),e.setAttribute("value","Manufacture/Decommission Tanks")}),r("input",e=>{e.setAttribute("type","hidden"),e.setAttribute("name","token"),u().then(n=>e.setAttribute("value",n))}),r("a",e=>{e.setAttribute("href","https://politicsandwar.com/nation/military/tanks/"),e.textContent="Go to Page"})),t.addEventListener("submit",p,{passive:!1}),[...t.querySelectorAll("input")].forEach(e=>e.toggleAttribute("disabled",!0)),s.then(e=>u().then(n=>[...t.querySelectorAll("input")].forEach(a=>a.toggleAttribute("disabled",!1))))});r("form",t=>{let o=document.querySelector("#rightcolumn>.row");o.parentElement.insertBefore(t,o),o.remove(),t.classList.add("doc_military"),t.append(r("label",e=>{e.classList.add("spacer-row"),e.append("Aircraft Possessed: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.aircraft.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Aircraft Manufactured Today: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.aircraft_today.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Manufacture/Decommission: ",i(),r("input",n=>{n.setAttribute("type","number"),n.setAttribute("name","aircraft"),n.setAttribute("value","0"),s.then(a=>{let l=a.cities.reduce((d,c)=>d+c.hangar,0)*15;n.value=Math.min(Math.round(l/5*(a.propaganda_bureau?1.1:1)-a.aircraft_today),l-a.aircraft).toString()})}))}),r("input",e=>{e.setAttribute("type","submit"),e.setAttribute("name","buyaircraft"),e.setAttribute("value","Manufacture/Decommission Aircraft")}),r("input",e=>{e.setAttribute("type","hidden"),e.setAttribute("name","token"),u().then(n=>e.setAttribute("value",n))}),r("a",e=>{e.setAttribute("href","https://politicsandwar.com/nation/military/aircraft/"),e.textContent="Go to Page"})),t.addEventListener("submit",p,{passive:!1}),[...t.querySelectorAll("input")].forEach(e=>e.toggleAttribute("disabled",!0)),s.then(e=>u().then(n=>[...t.querySelectorAll("input")].forEach(a=>a.toggleAttribute("disabled",!1))))});r("form",t=>{let o=document.querySelector("#rightcolumn>.row");o.parentElement.insertBefore(t,o),o.remove(),t.classList.add("doc_military"),t.append(r("label",e=>{e.classList.add("spacer-row"),e.append("Ships Possessed: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.ships.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Ships Manufactured Today: ",i(),r("span",n=>{n.append("?"),s.then(a=>n.textContent=a.ships_today.toString())}))}),r("label",e=>{e.classList.add("spacer-row"),e.append("Manufacture/Decommission: ",i(),r("input",n=>{n.setAttribute("type","number"),n.setAttribute("name","ships"),n.setAttribute("value","0"),s.then(a=>{let l=a.cities.reduce((d,c)=>d+c.drydock,0)*5;n.value=Math.min(Math.round(l/5*(a.propaganda_bureau?1.1:1)-a.ships_today),l-a.ships).toString()})}))}),r("input",e=>{e.setAttribute("type","submit"),e.setAttribute("name","buyships"),e.setAttribute("value","Manufacture/Decommission Ships")}),r("input",e=>{e.setAttribute("type","hidden"),e.setAttribute("name","token"),u().then(n=>e.setAttribute("value",n))}),r("a",e=>{e.setAttribute("href","https://politicsandwar.com/nation/military/navy/"),e.textContent="Go to Page"})),t.addEventListener("submit",p,{passive:!1}),[...t.querySelectorAll("input")].forEach(e=>e.toggleAttribute("disabled",!0)),Promise.all([s,u()]).then(()=>[...t.querySelectorAll("input")].forEach(e=>e.toggleAttribute("disabled",!1)))});async function p(t){for(t.preventDefault(),this.querySelectorAll("input").forEach(e=>e.toggleAttribute("disabled",!0));h;)await b(50);h=!0;let o=new DOMParser().parseFromString(await(await fetch(this.querySelector("a").href,{method:"POST",body:[...this.querySelectorAll("input[name][value]")].reduce((e,n)=>(e.append(n.name,n.value),e),new FormData)})).text(),"text/html").querySelector('input[name="token"]').value;document.querySelectorAll('input[name="token"]').forEach(e=>e.setAttribute("value",o)),h=!1}async function u(){for(;!sessionStorage.getItem("Doc_Token");)await b(50);return sessionStorage.getItem("Doc_Token")}
