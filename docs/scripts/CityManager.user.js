// ==UserScript==
// @name         Doc: City Manager
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.2
// @description  Improving the experience of switching improvements.
// @author       BlackAsLight
// @match        https://politicsandwar.com/city/id=*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
(()=>{function d(t,n=null,...a){if(typeof t!="string")return t(n,...a);let r=document.createElement(t);return n&&Object.entries(n).forEach(([i,e])=>{e&&r.setAttribute(i,e)}),a.flat().forEach(async i=>{if(i==null)return;if(i.toString()!=="[object Promise]")return r.append(i);let e=d("div",null);r.append(e),i=await i,i!=null&&e.parentElement&&e.parentElement.insertBefore(typeof i=="string"?document.createTextNode(i):i,e),e.remove()}),r}var l;(function(t){t[t.Money=0]="Money",t[t.Oil=1]="Oil",t[t.Coal=2]="Coal",t[t.Iron=3]="Iron",t[t.Bauxite=4]="Bauxite",t[t.Lead=5]="Lead",t[t.Uranium=6]="Uranium",t[t.Food=7]="Food",t[t.Gasoline=8]="Gasoline",t[t.Steel=9]="Steel",t[t.Aluminum=10]="Aluminum",t[t.Munitions=11]="Munitions",t[t.Credits=12]="Credits"})(l||(l={}));function f(t){return new Promise(n=>setTimeout(()=>n(!0),t))}async function s(t,n=0){for(;t();)await f(n)}function y(t,n){return n(t),t}function m(t,n){return n(t)}if(document.querySelector("#Doc_CityManager"))throw Error("This script was already injected...");document.body.append(d("div",{id:"Doc_CityManager",style:"display: none;"}));var u=document.querySelector('input[name="token"]').value,o=!1;document.querySelectorAll('form[action*="#improvements"]').forEach(t=>t.addEventListener("click",async function(n){if(!n.target||n.target.nodeName!=="INPUT")return;n.preventDefault();let a=n.target;a.toggleAttribute("disabled",!0),await s(()=>o),o=!0;let r=new DOMParser().parseFromString(await(await fetch(this.action,{method:"POST",body:(()=>{let e=new FormData;return e.append(a.name,a.value),e.append("token",u),e})()})).text(),"text/html");u=r.querySelector('input[name="token"]').value,m(a.parentElement,e=>e.nextElementSibling?e.nextElementSibling:e.previousElementSibling).textContent=m(r.querySelector(`input[name="${a.name}"]`).parentElement,e=>e.nextElementSibling?e.nextElementSibling:e.previousElementSibling).textContent;let i=[...document.querySelectorAll(".improvementQuantity")];r.querySelectorAll(".improvementQuantity").forEach((e,p)=>i[p].textContent=e.textContent),document.querySelector("#improvements").insertBefore(r.querySelector("#improvements>span"),y(document.querySelector("#improvements>span"),async e=>{await f(0),e.remove()})),o=!1,a.toggleAttribute("disabled",!1)}));})();
