// ==UserScript==
// @name         Doc: City Manager
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.2
// @description  Improving the experience of switching improvements.
// @author       BlackAsLight
// @match        https://politicsandwar.com/city/id=*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
(()=>{function f(t,e=null,...o){if(typeof t!="string")return t(e,...o);let a=document.createElement(t);return e&&Object.entries(e).forEach(([i,n])=>{n&&a.setAttribute(i,n)}),o.flat().forEach(async i=>{if(i==null)return;if(i.toString()!=="[object Promise]")return a.append(i);let n=f("div",null);a.append(n),i=await i,i!=null&&n.parentElement&&n.parentElement.insertBefore(typeof i=="string"?document.createTextNode(i):i,n),n.remove()}),a}var m;(function(t){t[t.Money=0]="Money",t[t.Oil=1]="Oil",t[t.Coal=2]="Coal",t[t.Iron=3]="Iron",t[t.Bauxite=4]="Bauxite",t[t.Lead=5]="Lead",t[t.Uranium=6]="Uranium",t[t.Food=7]="Food",t[t.Gasoline=8]="Gasoline",t[t.Steel=9]="Steel",t[t.Aluminum=10]="Aluminum",t[t.Munitions=11]="Munitions",t[t.Credits=12]="Credits"})(m||(m={}));var r;(function(t){t[t.Oil=0]="Oil",t[t.Coal=1]="Coal",t[t.Iron=2]="Iron",t[t.Bauxite=3]="Bauxite",t[t.Lead=4]="Lead",t[t.Uranium=5]="Uranium",t[t.Food=6]="Food",t[t.Gasoline=7]="Gasoline",t[t.Steel=8]="Steel",t[t.Aluminum=9]="Aluminum",t[t.Munitions=10]="Munitions",t[t.Credits=11]="Credits"})(r||(r={}));function s(t){return new Promise(e=>setTimeout(()=>e(!0),t))}async function y(t,e=0){for(;t();)await s(e)}function S(t,e){return e(t),t}function u(t,e){return e(t)}if(document.querySelector("#Doc_CityManager"))throw Error("This script was already injected...");document.body.append(f("div",{id:"Doc_CityManager",style:"display: none;"}));var d=document.querySelector('input[name="token"]').value,l=!1;document.querySelectorAll('form[action*="#improvements"]').forEach(t=>t.addEventListener("click",async function(e){if(!e.target||e.target.nodeName!=="INPUT")return;e.preventDefault();let o=e.target;o.toggleAttribute("disabled",!0),await y(()=>l),l=!0;let a=new DOMParser().parseFromString(await(await fetch(this.action,{method:"POST",body:(()=>{let n=new FormData;return n.append(o.name,o.value),n.append("token",d),n})()})).text(),"text/html");d=a.querySelector('input[name="token"]').value,u(o.parentElement,n=>n.nextElementSibling?n.nextElementSibling:n.previousElementSibling).textContent=u(a.querySelector(`input[name="${o.name}"]`).parentElement,n=>n.nextElementSibling?n.nextElementSibling:n.previousElementSibling).textContent;let i=[...document.querySelectorAll(".improvementQuantity")];a.querySelectorAll(".improvementQuantity").forEach((n,p)=>i[p].textContent=n.textContent),document.querySelector("#improvements").insertBefore(a.querySelector("#improvements>span"),S(document.querySelector("#improvements>span"),async n=>{await s(0),n.remove()})),l=!1,o.toggleAttribute("disabled",!1)}));})();
