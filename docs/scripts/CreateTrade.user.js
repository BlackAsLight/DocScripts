// ==UserScript==
// @name         Doc: Create Trade
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      2.7
// @description  Makes script, View Trades, Outbid and Match buttons work.
// @author       BlackAsLight
// @match        https://politicsandwar.com/nation/trade/create/*
// @include      https://politicsandwar.com/index.php?id=27*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
(()=>{function g(t,e=null,...n){if(typeof t!="string")return t(e,...n);let o=document.createElement(t);return e&&Object.entries(e).forEach(([i,a])=>{a&&o.setAttribute(i,a)}),n.flat().forEach(async i=>{if(i==null)return;if(i.toString()!=="[object Promise]")return o.append(i);let a=g("div",null);o.append(a),i=await i,i!=null&&a.parentElement&&a.parentElement.insertBefore(typeof i=="string"?document.createTextNode(i):i,a),a.remove()}),o}var u;(function(t){t[t.Money=0]="Money",t[t.Oil=1]="Oil",t[t.Coal=2]="Coal",t[t.Iron=3]="Iron",t[t.Bauxite=4]="Bauxite",t[t.Lead=5]="Lead",t[t.Uranium=6]="Uranium",t[t.Food=7]="Food",t[t.Gasoline=8]="Gasoline",t[t.Steel=9]="Steel",t[t.Aluminum=10]="Aluminum",t[t.Munitions=11]="Munitions",t[t.Credits=12]="Credits"})(u||(u={}));var d;(function(t){t[t.Oil=0]="Oil",t[t.Coal=1]="Coal",t[t.Iron=2]="Iron",t[t.Bauxite=3]="Bauxite",t[t.Lead=4]="Lead",t[t.Uranium=5]="Uranium",t[t.Food=6]="Food",t[t.Gasoline=7]="Gasoline",t[t.Steel=8]="Steel",t[t.Aluminum=9]="Aluminum",t[t.Munitions=10]="Munitions",t[t.Credits=11]="Credits"})(d||(d={}));function b(t){return new Promise(e=>setTimeout(()=>e(!0),t))}if(document.querySelector("#Doc_CreateTrade"))throw Error("This script was already injected...");document.body.append(g("div",{id:"Doc_CreateTrade",style:"display: none;"}));var m="Doc_CT1",r="Doc_CT2",f="Doc_CT3",{resource:p,p:c,q:l,t:s}=Object.fromEntries(location.search.slice(1).split("&").map(t=>t.split("=")).map(([t,e])=>[t,`${parseFloat(e)}`=="NaN"?e:parseFloat(e)]));if(document.querySelector(".alert-success"))if(l&&l>1e6&&localStorage.getItem(r)){localStorage.removeItem(r);let t=location.search.slice(1).split("&"),e=t.findIndex(n=>n.startsWith("q="));t[e]=`q=${l-1e6}`,location.href=location.origin+location.pathname+"?"+t.join("&")}else if(p)location.href=`https://politicsandwar.com/index.php?id=26&display=world&resource1=${p}&buysell=${["buy","sell"][parseInt(localStorage.getItem("Doc_MarketView"))]??""}&ob=price&od=DEF&maximum=100&minimum=0&search=Go`;else{let t=document.querySelector("a i.fa-backward").parentElement.href.split("?"),e=t[1].split("&"),n=e.findIndex(o=>o.startsWith("minimum="));n<0?location.href=t.join("?"):(e[n]="minimum=0",location.href=t[0]+"?"+e.join("&"))}else if(document.querySelector("#createTrade")){if(localStorage.removeItem(r),document.querySelector("#createTrade")?.scrollIntoView({behavior:"smooth",block:"center"}),c){let t=document.querySelector("#priceper");t.setAttribute("value",c),t.addEventListener("change",()=>{let e=t.value;parseInt(e)===c?localStorage.removeItem(f):localStorage.setItem(f,e)})}if(l&&document.querySelector("#amount").setAttribute("value",Math.min(l,1e6).toString()),s){let t=(()=>{let n=document.querySelector("button i.fa-hands-usd").parentElement,o=n.nextElementSibling;return(s==="s"?o:n).remove(),s==="s"?n:o})();t.style.setProperty("border-radius","6px"),t.setAttribute("type","submit"),t.setAttribute("name","submit"),t.setAttribute("value",s==="s"?"Sell":"Buy"),t.removeAttribute("data-target");let e=parseInt(localStorage.getItem(m)??"");if(e){let n=5e3+e-new Date().getTime();n>0&&(b(n).then(()=>t.toggleAttribute("disabled",!1)),t.toggleAttribute("disabled",!0)),localStorage.removeItem(m)}l&&l>=1e6&&t.addEventListener("click",()=>{Math.min(l,1e6)===parseInt(document.querySelector("#amount").getAttribute("value")??"")&&(localStorage.setItem(m,`${new Date().getTime()}`),localStorage.setItem(r,"0"))})}}})();
