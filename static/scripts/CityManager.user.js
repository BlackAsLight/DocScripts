// ==UserScript==
// @name         Doc: City Manager
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.3
// @description  Improving the experience of switching improvements.
// @author       BlackAsLight
// @match        https://politicsandwar.com/city/id=*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
function u(t,e,...n){return typeof t!="string"?t(e,...n):{type:t,props:e,children:n.flat()}}function c(t){let e=m(t);if(t.children){let n=e,i=[0],o;do{{let r=t;for(let a=i.length-1;0<a;--a)r=r.children[i[a]];o=r.children}for(;i[0]<o.length;)typeof o[i[0]]=="string"?n.append(o[i[0]++]):(n.append(m(o[i[0]])),n=n.lastChild,o=o[i[0]].children??[],i.unshift(0));n=n.parentElement,i.shift(),++i[0]}while(i.length&&n)}return e}function m(t){let e=document.createElement(t.type);if(t.props){let n=Object.entries(t.props);for(let i=0;i<n.length;++i)e.setAttribute(n[i][0],n[i][1])}return e}function l(t){return new Promise(e=>setTimeout(()=>e(!0),t))}async function f(t,e=0){for(;t();)await l(e)}function g(t,e){return e(t),t}function p(t,e){return e(t)}if(document.querySelector("#Doc_CityManager"))throw Error("This script was already injected...");document.body.append(c(u("div",{id:"Doc_CityManager",style:"display: none;"})));var d=document.querySelector('input[name="token"]').value,s=!1;document.querySelectorAll('form[action*="#improvements"]').forEach(t=>t.addEventListener("click",async function(e){if(!e.target||e.target.nodeName!=="INPUT")return;e.preventDefault();let n=e.target;n.toggleAttribute("disabled",!0),await f(()=>s),s=!0;let i=new DOMParser().parseFromString(await(await fetch(this.action,{method:"POST",body:(()=>{let r=new FormData;return r.append(n.name,n.value),r.append("token",d),r})()})).text(),"text/html");d=i.querySelector('input[name="token"]').value,p(n.parentElement,r=>r.nextElementSibling?r.nextElementSibling:r.previousElementSibling).textContent=p(i.querySelector(`input[name="${n.name}"]`).parentElement,r=>r.nextElementSibling?r.nextElementSibling:r.previousElementSibling).textContent;let o=[...document.querySelectorAll(".improvementQuantity")];i.querySelectorAll(".improvementQuantity").forEach((r,a)=>o[a].textContent=r.textContent),document.querySelector("#improvements").insertBefore(i.querySelector("#improvements>span"),g(document.querySelector("#improvements>span"),async r=>{await l(0),r.remove()})),s=!1,n.toggleAttribute("disabled",!1)}));
