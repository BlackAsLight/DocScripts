// ==UserScript==
// @name         Doc: Create Trade
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      2.9
// @description  Makes script, View Trades, Outbid and Match buttons work.
// @author       BlackAsLight
// @match        https://politicsandwar.com/nation/trade/create/*
// @match        https://politicsandwar.com/index.php?id=27*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
function p(e,t,...n){return typeof e!="string"?e(t,...n):{type:e,props:t,children:n.flat()}}function m(e){let t=c(e);if(e.children){let n=t,r=[0],i;do{{let s=e;for(let u=r.length-1;0<u;--u)s=s.children[r[u]];i=s.children}for(;r[0]<i.length;)typeof i[r[0]]=="string"?n.append(i[r[0]++]):(n.append(c(i[r[0]])),n=n.lastChild,i=i[r[0]].children??[],r.unshift(0));n=n.parentElement,r.shift(),++r[0]}while(r.length&&n)}return t}function c(e){let t=document.createElement(e.type);if(e.props){let n=Object.entries(e.props);for(let r=0;r<n.length;++r)t.setAttribute(n[r][0],n[r][1])}return t}function f(e){return new Promise(t=>setTimeout(()=>t(!0),e))}if(document.querySelector("#Doc_CreateTrade"))throw Error("This script was already injected...");document.body.append(m(p("div",{id:"Doc_CreateTrade",style:"display: none;"})));var{resource:d,p:a,q:o,t:l}=Object.fromEntries(self.location.search.slice(1).split("&").map(e=>{let[t,n]=e.split("="),r=parseFloat(n);return`${r}`=="NaN"?[t,n]:[t,r]}));if(document.querySelector(".alert-success"))if(localStorage.setItem("!Doc_CT1",`${new Date().getTime()+5e3}`),o&&o>1e7&&localStorage.getItem("!Doc_CT2")){let e=self.location.search.slice(1).split("&");e[e.findIndex(t=>t.startsWith("q="))]=`q=${o-1e7}`,localStorage.getItem("!Doc_CT3")&&(e[e.findIndex(t=>t.startsWith("p="))]=`p=${localStorage.getItem("!Doc_CT3")}`,localStorage.removeItem("!Doc_CT3")),self.location.href=self.location.origin+self.location.pathname+"?"+e.join("&")}else self.location.href=`https://politicsandwar.com/index.php?id=26&display=world&resource1=${d??document.querySelector('.alert-success a[href^="https://politicsandwar.com/index.php"]').href.split("?")[1].split("&").find(e=>e.startsWith("resource1="))?.split("=")[1]}&buysell=${["buy","sell"][parseInt(localStorage.getItem("Doc_MarketView"))]??""}&ob=price&od=DEF&maximum=100&minimum=0&search=Go`;else if(d&&document.querySelector("form#createTrade")){localStorage.removeItem("!Doc_CT2");let e=document.querySelector("form#createTrade");if(e.scrollIntoView({behavior:"smooth",block:"center"}),e.addEventListener("submit",t=>{if(a){let n=document.querySelector("input#priceper").valueAsNumber;n!==a&&localStorage.setItem("!Doc_CT3",`${n}`)}o&&o>=1e7&&document.querySelector("input#amount").valueAsNumber===1e7&&localStorage.setItem("!Doc_CT2","0")}),a&&document.querySelector("input#priceper").setAttribute("value",`${a}`),o&&document.querySelector("input#amount").setAttribute("value",`${Math.min(o,1e7)}`),l){document.querySelector(`button[data-target="#${l==="s"?"buy":"sell"}Confirmation"]`).remove();let t=document.querySelector(`button[data-target="#${l==="s"?"sell":"buy"}Confirmation"]`);t.style.setProperty("border-radius","6px"),t.setAttribute("type","submit"),t.setAttribute("name","submit"),t.setAttribute("value",l==="s"?"Sell":"Buy"),t.removeAttribute("data-target");let n=parseInt(localStorage.getItem("!Doc_CT1")??"0")-new Date().getTime();n>0&&(t.toggleAttribute("disabled",!0),f(n).then(()=>t.toggleAttribute("disabled",!1)))}}
