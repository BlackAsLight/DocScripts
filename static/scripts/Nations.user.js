// ==UserScript==
// @name         Doc: Nations
// @namespace    https://politicsandwar.com/nation/id=19818
// @version      0.5
// @description  Improves the Nations page UI
// @author       BlackAsLight
// @match        https://politicsandwar.com/nations/
// @include      https://politicsandwar.com/index.php?id=15*
// @icon         https://avatars.githubusercontent.com/u/44320105
// @grant        none
// ==/UserScript==
'use strict';
function r(n,i,...t){return typeof n!="string"?n(i,...t):{type:n,props:i,children:t.flat()}}function l(n){let i=document.createElement(n.type);if(f(i,n.props),n.children){let t=i,e=[0],o;do{{let a=n;for(let p=e.length-1;0<p;--p)a=a.children[e[p]];o=a.children}for(;e[0]<o.length;)if(typeof o[e[0]]!="object")t.append(o[e[0]++]);else{let a=document.createElement(o[e[0]].type);a.toString()==="[object HTMLUnknownElement]"?t.append(o[e[0]++]):(t.append(a),f(a,o[e[0]].props),t=a,o=o[e[0]].children??[],e.unshift(0))}t=t.parentElement,e.shift(),++e[0]}while(e.length&&t)}return i}function f(n,i){if(i){let t=Object.entries(i);for(let e=0;e<t.length;++e)n.setAttribute(t[e][0],t[e][1])}}function c(n,i){return i(n),n}if(document.querySelector("#Doc_Nations"))throw Error("This script was already injected...");document.body.append(l(r("div",{id:"Doc_Nations",style:"display: none;"})));var s="Doc_N1",m="Doc_N2",d=document.querySelector('form[method="GET"]');d.parentElement?.insertBefore(l(r("div",null,r("label",{for:"Doc_Score"},"Nation Score: "),c(l(r("input",{id:"Doc_Score",type:"number",value:`${localStorage.getItem(s)??0}`})),n=>n.addEventListener("change",i=>{let t=i.target,e=parseFloat(t.value);if(`${e}`=="NaN")return;let o=new Date;t.nextSibling&&(t.nextSibling.textContent=o.toJSON()),localStorage.setItem(m,`${o.getTime()}`),localStorage.setItem(s,`${e}`),g(e)})),r("br",null),new Date(parseInt(localStorage.getItem(m)??"0")).toJSON(),c(l(r("button",{class:"btn btn-primary",style:"margin-inline: 0.5em;"},"Refresh")),n=>n.addEventListener("click",async i=>{let t=i.target;t.toggleAttribute("disabled",!0);let e=parseFloat(new DOMParser().parseFromString(await(await fetch("https://politicsandwar.com/nation/war/")).text(),"text/html").querySelector('a[href^="/index.php?id=15"]').href.split("?")[1].split("&").find(a=>a.startsWith("keyword="))?.slice(8)??"0");console.log(`Score: ${e}`);let o=new Date;t.previousSibling&&(t.previousSibling.textContent=o.toJSON()),localStorage.setItem(m,`${o.getTime()}`),localStorage.setItem(s,`${e}`),g(e),t.previousElementSibling.previousElementSibling.value=`${e}`,t.toggleAttribute("disabled",!1)})))),d.nextElementSibling);g(parseFloat(localStorage.getItem(s)??"0"));function T(n,i){return i*.4<=n&&n<=i*2.5}function u(n,i){return i*.75<=n&&n<=i*1.75}function g(n){[...document.querySelectorAll(".nationtable tr")].slice(1).forEach(i=>{let t=i.lastElementChild,e=parseFloat(t.lastChild?.textContent?.replaceAll(",",""));[...t.querySelectorAll("img")].forEach(o=>{o.src!=="https://politicsandwar.com/img/icons/16/plus_shield.png"&&o.remove()}),T(e,n)&&t.insertBefore(l(r("img",{src:"https://politicsandwar.com/img/icons/16/emotion_spy.png"})),t.lastChild),u(e,n)?u(n,e)?t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/green_red.png"})),t.lastChild):t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/green.png"})),t.lastChild):u(n,e)&&t.insertBefore(l(r("img",{src:"https://docscripts.stagintin.com/icons/red.png"})),t.lastChild)})}
